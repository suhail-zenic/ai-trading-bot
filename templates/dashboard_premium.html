<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Crypto Trading Bot - Premium Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        
        .bg-animation::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 50%);
            animation: pulse 15s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        header {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 25px 30px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.6s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            animation: rotate 20s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        h1 {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            animation: fadeIn 0.6s ease-out;
        }
        
        .status-badge.running {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }
        
        .status-badge.stopped {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }
        
        .pulse-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
            animation: pulse-dot 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        /* Controls */
        .controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        button:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-start {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        
        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
        }
        
        .btn-stop {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }
        
        .btn-stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6);
        }
        
        .btn-refresh {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        
        .btn-mode-toggle {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        /* Cards */
        .card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            animation: fadeInUp 0.6s ease-out;
            animation-fill-mode: both;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            border-color: var(--primary);
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .icon-primary { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
        .icon-success { background: linear-gradient(135deg, #10b981, #059669); }
        .icon-warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .icon-danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
        
        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .card-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
            margin-top: 10px;
            animation: countUp 1s ease-out;
        }
        
        @keyframes countUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 8px;
        }
        
        .trend {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .trend.up {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .trend.down {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        /* Wide Cards */
        .card-wide {
            grid-column: 1 / -1;
        }
        
        /* Logs Viewer */
        .logs-container {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 12px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .log-entry {
            padding: 8px 12px;
            border-left: 3px solid transparent;
            margin-bottom: 5px;
            border-radius: 4px;
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .log-entry.info { border-left-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .log-entry.success { border-left-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .log-entry.warning { border-left-color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
        .log-entry.error { border-left-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        
        .log-timestamp {
            color: var(--text-secondary);
            margin-right: 10px;
        }
        
        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        /* Table */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }
        
        td {
            padding: 15px 12px;
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
            font-size: 14px;
        }
        
        tr:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-success { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .badge-danger { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .badge-warning { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        
        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .controls {
                width: 100%;
            }
            
            button {
                flex: 1;
                justify-content: center;
            }
            
            .card-value {
                font-size: 24px;
            }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .empty-state p {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    
    <div class="container">
        <!-- Header -->
        <header>
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div>
                        <h1>AI Crypto Trading Bot</h1>
                        <div class="status-badge" id="statusBadge">
                            <span class="pulse-dot"></span>
                            <span id="statusText">LOADING</span>
                            <span style="font-weight: 400; font-size: 11px;">Mode: <span id="tradingMode">PAPER</span></span>
                        </div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn-start" id="startBtn" onclick="startBot()">
                        <i class="fas fa-play"></i>
                        <span>Start Bot</span>
                    </button>
                    <button class="btn-stop" id="stopBtn" onclick="stopBot()" disabled>
                        <i class="fas fa-stop"></i>
                        <span>Stop Bot</span>
                    </button>
                    <button class="btn-refresh" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i>
                        <span>Refresh</span>
                    </button>
                    <button class="btn-mode-toggle" onclick="toggleMode()">
                        <i class="fas fa-exchange-alt"></i>
                        <span id="modeToggleText">Switch to LIVE</span>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Portfolio Summary Cards -->
        <div class="dashboard-grid">
            <div class="card" style="animation-delay: 0.1s">
                <div class="card-header">
                    <div class="card-icon icon-primary">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <h3 class="card-title">Total Capital</h3>
                </div>
                <div class="card-value" id="capitalValue">$0.00</div>
                <div class="card-subtitle">Available for trading</div>
            </div>
            
            <div class="card" style="animation-delay: 0.2s">
                <div class="card-header">
                    <div class="card-icon icon-success">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3 class="card-title">Total P&L</h3>
                </div>
                <div class="card-value" id="totalPnlValue">$0.00</div>
                <div class="trend up" id="pnlTrend">
                    <i class="fas fa-arrow-up"></i>
                    <span>0.00%</span>
                </div>
            </div>
            
            <div class="card" style="animation-delay: 0.3s">
                <div class="card-header">
                    <div class="card-icon icon-warning">
                        <i class="fas fa-briefcase"></i>
                    </div>
                    <h3 class="card-title">Open Positions</h3>
                </div>
                <div class="card-value" id="positionsValue">0</div>
                <div class="card-subtitle">Active trades</div>
            </div>
            
            <div class="card" style="animation-delay: 0.4s">
                <div class="card-header">
                    <div class="card-icon icon-primary">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <h3 class="card-title">Win Rate</h3>
                </div>
                <div class="card-value" id="winRateValue">0%</div>
                <div class="card-subtitle" id="winRateStats">0/0 trades won</div>
            </div>
        </div>
        
        <!-- Charts Row -->
        <div class="dashboard-grid">
            <div class="card card-wide" style="animation-delay: 0.5s">
                <div class="card-header">
                    <div class="card-icon icon-success">
                        <i class="fas fa-chart-area"></i>
                    </div>
                    <h3 class="card-title">Portfolio Performance</h3>
                </div>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Live Logs -->
        <div class="dashboard-grid">
            <div class="card card-wide" style="animation-delay: 0.6s">
                <div class="card-header">
                    <div class="card-icon icon-primary">
                        <i class="fas fa-terminal"></i>
                    </div>
                    <h3 class="card-title">Live Activity Logs</h3>
                </div>
                <div class="logs-container" id="logsContainer">
                    <div class="log-entry info">
                        <span class="log-timestamp">[--:--:--]</span>
                        <span>Waiting for bot to start...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Positions Table -->
        <div class="dashboard-grid">
            <div class="card card-wide" style="animation-delay: 0.7s">
                <div class="card-header">
                    <div class="card-icon icon-warning">
                        <i class="fas fa-briefcase"></i>
                    </div>
                    <h3 class="card-title">Open Positions</h3>
                </div>
                <div class="table-container" id="positionsTable">
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>No Open Positions</h3>
                        <p>Start the bot to begin trading</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Trade History -->
        <div class="dashboard-grid">
            <div class="card card-wide" style="animation-delay: 0.8s">
                <div class="card-header">
                    <div class="card-icon icon-success">
                        <i class="fas fa-history"></i>
                    </div>
                    <h3 class="card-title">Trade History</h3>
                </div>
                <div class="table-container" id="tradesTable">
                    <div class="empty-state">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <h3>No Trades Yet</h3>
                        <p>Trade history will appear here</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let updateInterval;
        let performanceChart;
        let logs = [];
        
        // Initialize Chart
        function initChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Portfolio Value',
                        data: [],
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }
        
        // Add Log Entry
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.unshift({ timestamp, message, type });
            if (logs.length > 50) logs.pop();
            updateLogsDisplay();
        }
        
        // Update logs from server
        function updateLogsFromServer(serverLogs) {
            // Convert server log levels to types
            const levelMap = {
                'info': 'info',
                'warning': 'warning',
                'error': 'error',
                'success': 'success',
                'debug': 'info'
            };
            
            logs = serverLogs.map(log => ({
                timestamp: log.timestamp,
                message: log.message,
                type: levelMap[log.level] || 'info'
            }));
            
            updateLogsDisplay();
        }
        
        // Update logs display
        function updateLogsDisplay() {
            const logsContainer = document.getElementById('logsContainer');
            if (logs.length === 0) {
                logsContainer.innerHTML = `
                    <div class="log-entry info">
                        <span class="log-timestamp">[--:--:--]</span>
                        <span>Waiting for bot activity...</span>
                    </div>
                `;
                return;
            }
            
            logsContainer.innerHTML = logs.slice(0, 50).map(log => `
                <div class="log-entry ${log.type}">
                    <span class="log-timestamp">[${log.timestamp}]</span>
                    <span>${log.message}</span>
                </div>
            `).join('');
            
            // Auto-scroll to latest (top)
            logsContainer.scrollTop = 0;
        }
        
        // Start Bot
        async function startBot() {
            try {
                addLog('Starting bot...', 'info');
                const response = await axios.post('/api/start');
                if (response.data.success) {
                    addLog('Bot started successfully!', 'success');
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    startAutoUpdate();
                } else {
                    addLog('Failed to start bot: ' + response.data.message, 'error');
                }
            } catch (error) {
                addLog('Error starting bot: ' + error.message, 'error');
            }
        }
        
        // Stop Bot
        async function stopBot() {
            try {
                addLog('Stopping bot...', 'warning');
                const response = await axios.post('/api/stop');
                if (response.data.success) {
                    addLog('Bot stopped successfully', 'warning');
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                    stopAutoUpdate();
                } else {
                    addLog('Failed to stop bot: ' + response.data.message, 'error');
                }
            } catch (error) {
                addLog('Error stopping bot: ' + error.message, 'error');
            }
        }
        
        // Toggle Trading Mode
        async function toggleMode() {
            const currentMode = document.getElementById('tradingMode').textContent;
            const newMode = currentMode === 'PAPER' ? 'live' : 'paper';
            
            if (newMode === 'live') {
                if (!confirm('⚠️ WARNING: Switching to LIVE mode will use REAL MONEY!\n\nThis will place real orders on Binance.\nLosses are REAL and PERMANENT.\n\nAre you absolutely sure?')) {
                    return;
                }
            }
            
            try {
                addLog(`Switching to ${newMode.toUpperCase()} mode...`, 'warning');
                const response = await axios.post('/api/mode/switch', { mode: newMode });
                
                if (response.data.success) {
                    document.getElementById('tradingMode').textContent = newMode.toUpperCase();
                    document.getElementById('modeToggleText').textContent = `Switch to ${currentMode}`;
                    addLog(`✓ ${response.data.message}`, 'success');
                    if (response.data.note) {
                        addLog(`ℹ ${response.data.note}`, 'info');
                    }
                    // Refresh mode display
                    await loadCurrentMode();
                } else {
                    addLog(`✗ ${response.data.message}`, 'error');
                }
            } catch (error) {
                addLog(`Error switching mode: ${error.message}`, 'error');
            }
        }
        
        // Load Current Mode
        async function loadCurrentMode() {
            try {
                const response = await axios.get('/api/mode');
                const mode = response.data.mode.toUpperCase();
                document.getElementById('tradingMode').textContent = mode;
                const toggleText = mode === 'PAPER' ? 'Switch to LIVE' : 'Switch to PAPER';
                document.getElementById('modeToggleText').textContent = toggleText;
                
                // Update mode indicator color
                const modeElement = document.getElementById('tradingMode');
                if (mode === 'LIVE') {
                    modeElement.style.color = '#ef4444';
                    modeElement.style.fontWeight = 'bold';
                } else {
                    modeElement.style.color = '#10b981';
                    modeElement.style.fontWeight = 'bold';
                }
            } catch (error) {
                console.error('Error loading mode:', error);
            }
        }
        
        // Refresh Data
        async function refreshData() {
            addLog('Refreshing data...', 'info');
            await updateDashboard();
        }
        
        // Update Dashboard
        async function updateDashboard() {
            try {
                // Add refresh indicator
                const statusBadge = document.getElementById('statusBadge');
                const originalText = statusBadge ? statusBadge.textContent : '';
                
                const [statusRes, positionsRes, tradesRes, logsRes] = await Promise.all([
                    axios.get('/api/status'),
                    axios.get('/api/positions'),
                    axios.get('/api/trades'),
                    axios.get('/api/logs')
                ]);
                
                const status = statusRes.data;
                const positions = positionsRes.data.positions || [];
                const trades = tradesRes.data.trades || [];
                const serverLogs = logsRes.data.logs || [];
                
                // Debug: Log received data
                console.log('Dashboard Update:', {
                    status: status.status,
                    capital: status.capital,
                    positions: status.portfolio.open_positions,
                    trades: status.stats.total_trades,
                    pnl: status.stats.total_pnl
                });
                
                // Update logs from server
                if (serverLogs.length > 0) {
                    updateLogsFromServer(serverLogs);
                }
                
                // Update Status Badge
                const statusText = document.getElementById('statusText');
                if (status.is_running) {
                    if (statusBadge) statusBadge.className = 'status-badge running';
                    if (statusText) statusText.textContent = 'RUNNING';
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                } else {
                    if (statusBadge) statusBadge.className = 'status-badge stopped';
                    if (statusText) statusText.textContent = 'STOPPED';
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                }
                
                // Update Cards with safe element checks
                const capitalEl = document.getElementById('capitalValue');
                const pnlEl = document.getElementById('totalPnlValue');
                const positionsEl = document.getElementById('positionsValue');
                const winRateEl = document.getElementById('winRateValue');
                
                if (capitalEl) capitalEl.textContent = '$' + (status.capital || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                if (pnlEl) pnlEl.textContent = '$' + (status.stats.total_pnl || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                if (positionsEl) positionsEl.textContent = status.portfolio.open_positions || 0;
                if (winRateEl) winRateEl.textContent = ((status.stats.win_rate || 0) * 100).toFixed(1) + '%';
                
                // Update P&L Trend
                const pnlTrend = document.getElementById('pnlTrend');
                const pnl = status.stats.total_pnl || 0;
                if (pnl > 0) {
                    pnlTrend.className = 'trend up';
                    pnlTrend.innerHTML = '<i class="fas fa-arrow-up"></i><span>+' + ((pnl / status.capital) * 100).toFixed(2) + '%</span>';
                } else if (pnl < 0) {
                    pnlTrend.className = 'trend down';
                    pnlTrend.innerHTML = '<i class="fas fa-arrow-down"></i><span>' + ((pnl / status.capital) * 100).toFixed(2) + '%</span>';
                } else {
                    pnlTrend.className = 'trend';
                    pnlTrend.innerHTML = '<span>0.00%</span>';
                }
                
                // Update Positions Table
                updatePositionsTable(positions);
                
                // Update Trades Table
                updateTradesTable(trades);
                
                // Update Chart
                updateChart(status.capital + status.stats.total_pnl);
                
            } catch (error) {
                console.error('Error updating dashboard:', error);
                addLog('Error updating dashboard: ' + error.message, 'error');
            }
        }
        
        // Update Positions Table
        function updatePositionsTable(positions) {
            const container = document.getElementById('positionsTable');
            
            if (!positions || positions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>No Open Positions</h3>
                        <p>Positions will appear here when trades are active</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Amount</th>
                            <th>Entry Price</th>
                            <th>Current Price</th>
                            <th>P&L</th>
                            <th>P&L %</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${positions.map(pos => `
                            <tr>
                                <td><strong>${pos.symbol}</strong></td>
                                <td>${pos.amount?.toFixed(4) || 0}</td>
                                <td>$${pos.entry_price?.toFixed(2) || 0}</td>
                                <td>$${pos.current_price?.toFixed(2) || 0}</td>
                                <td style="color: ${pos.profit >= 0 ? '#10b981' : '#ef4444'}">
                                    ${pos.profit >= 0 ? '+' : ''}$${pos.profit?.toFixed(2) || 0}
                                </td>
                                <td style="color: ${pos.profit_pct >= 0 ? '#10b981' : '#ef4444'}">
                                    ${pos.profit_pct >= 0 ? '+' : ''}${pos.profit_pct?.toFixed(2) || 0}%
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // Update Trades Table
        function updateTradesTable(trades) {
            const container = document.getElementById('tradesTable');
            
            if (!trades || trades.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <h3>No Trades Yet</h3>
                        <p>Trade history will appear here</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Symbol</th>
                            <th>Type</th>
                            <th>Price</th>
                            <th>Amount</th>
                            <th>P&L</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${trades.slice(0, 20).map(trade => `
                            <tr>
                                <td>${new Date(trade.timestamp).toLocaleString()}</td>
                                <td><strong>${trade.symbol}</strong></td>
                                <td><span class="badge badge-${trade.type === 'BUY' ? 'success' : 'danger'}">${trade.type}</span></td>
                                <td>$${trade.price?.toFixed(2) || 0}</td>
                                <td>${trade.amount?.toFixed(4) || 0}</td>
                                <td style="color: ${(trade.profit || 0) >= 0 ? '#10b981' : '#ef4444'}">
                                    ${trade.profit ? ((trade.profit >= 0 ? '+' : '') + '$' + trade.profit.toFixed(2)) : '-'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // Update Chart
        function updateChart(value) {
            const now = new Date().toLocaleTimeString();
            performanceChart.data.labels.push(now);
            performanceChart.data.datasets[0].data.push(value);
            
            if (performanceChart.data.labels.length > 20) {
                performanceChart.data.labels.shift();
                performanceChart.data.datasets[0].data.shift();
            }
            
            performanceChart.update('none');
        }
        
        // Auto Update
        function startAutoUpdate() {
            updateInterval = setInterval(updateDashboard, 2000); // Update every 2 seconds
        }
        
        function stopAutoUpdate() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            initChart();
            addLog('Dashboard initialized', 'success');
            await loadCurrentMode();  // Load trading mode
            await updateDashboard();
            
            // Auto-refresh every 2 seconds for real-time updates
            setInterval(updateDashboard, 2000);
        });
    </script>
</body>
</html>

